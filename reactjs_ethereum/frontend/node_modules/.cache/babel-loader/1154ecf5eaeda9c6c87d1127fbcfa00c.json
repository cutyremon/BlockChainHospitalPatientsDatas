{"ast":null,"code":"'use strict';\n\nvar CID = require('cids');\n\nvar base32 = require('base32.js');\n\nvar pull = require('pull-stream');\n\nvar pullDefer = require('pull-defer');\n\nmodule.exports = function (self) {\n  return function () {\n    var deferred = pullDefer.source();\n\n    self._repo.blocks.query({\n      keysOnly: true\n    }, function (err, blocks) {\n      if (err) {\n        return deferred.resolve(pull.error(err));\n      }\n\n      var refs = blocks.map(function (b) {\n        return dsKeyToRef(b.key);\n      });\n      deferred.resolve(pull.values(refs));\n    });\n\n    return deferred;\n  };\n};\n\nfunction dsKeyToRef(key) {\n  try {\n    // Block key is of the form /<base32 encoded string>\n    var decoder = new base32.Decoder();\n    var buff = Buffer.from(decoder.write(key.toString().slice(1)).finalize());\n    return {\n      ref: new CID(buff).toString()\n    };\n  } catch (err) {\n    return {\n      err: \"Could not convert block with key '\".concat(key, \"' to CID: \").concat(err.message)\n    };\n  }\n}","map":null,"metadata":{},"sourceType":"script"}